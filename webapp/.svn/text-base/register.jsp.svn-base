<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme() + "://"
			+ request.getServerName() + ":" + request.getServerPort()
			+ path + "/";
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<base href="<%=basePath%>">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>p2p网贷平台</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<script src="<%=basePath%>libs/jquery-1.12.4.min.js" type="text/javascript" charset="utf-8"></script>
 <script type="text/javascript" src="<%=basePath%>jq/jquery.js"></script>
<link rel="stylesheet" href="<%=basePath%>css/123.css" type="text/css" media="all">
<script src="<%=basePath%>js/regs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="<%=basePath%>jq/jquery-1.7.2.min.js"></script>
</head>
<body>
	<h1 align="center" >富二贷公司欢迎你</h1>

	<div class="container w3layouts agileits">

		<div class="login w3layouts agileits">
			<h2 >注 册</h2>
			<form action="<%=basePath%>user/insert" method="post" id="sub">
				<input type="text" name="username" placeholder="用户名" onblur="myBlur(this)" id="username">&nbsp;&nbsp;<font id="nameFont"></font><p>
				<input type="password" name="userpwd" placeholder="密码"  onblur="myBlur(this)">&nbsp;&nbsp;<font id="fontPwd"></font><p>
				<input type="password" name="twouserpwd" placeholder="确认密码" onblur="myBlur(this)">&nbsp;&nbsp;<font id="twoPadFont"></font><p>
				<input type="text" maxlength="11" placeholder="请输入手机号码" id="phone" name="usertel" onblur="phones()" class="tel w3layouts agileits" >
				<input type="button" class="btn btn-block btn-flat" id="verify_refresh" onclick="getMsgNum(this)" value="免费获取验证码" ><p>
				<input type="text" id="msg_num" placeholder="请输入手机验证码" "><span id="sp"></span><p>
			<div class="send-button w3layouts agileits">
					<input type="button"  onclick="validateNum(this)"   onsubmit="return mySubmit()" value="注 册">

			</div>
			<a href="<%=basePath%>index.jsp">返回首页</a>
		<div class="clear"></div>
</form>
	</div>
</div>
<script type="text/javascript">
var nameFlag=false;
var padFlag=false;
var twoPadFlag=false;
var iphone=false;
var messageData;
var wait = 60; // 短信验证码120秒后才可获取下一个
var phoneYz=false;

/**
 * 获取验证码
 * @param that
 */
function getMsgNum(that) {
    if(iphone==true){
    	/* alert("手机验证是:"+phoneYz); */
    	var phoneNumber=$("#phone").val();
	    setButtonStatus(that); // 设置按钮倒计时
	    var obj = {
	        phoneNumber: phoneNumber
	    };
	
	    $.ajax({
	        url:"<%=basePath%>user/sendMsg", // 后台短信发送接口
	        type: 'post',
	        dataType: 'json',
	        contentType: "application/json",
	        async: false, //false 同步
	        data: JSON.stringify(obj),
	        xhrFields: {
	            withCredentials: true
	        },
	        success: function (result) {
	            if(result.code == '200') {
	                messageData = result.data;
	            }else {
	                alert("错误码:" + data.code + "  错误信息:" + data.message);
	            }
	        },
	        error: function (XMLHttpRequest, textStatus, errorThrown) {
	            console.log(XMLHttpRequest.status);
	            console.log(XMLHttpRequest.readyState);
	            console.log(textStatus);
	        }
	    });
    }else{
    	alert("请输入手机号码");
    }
}
	


/** 
 * 设置按钮状态
 */
function setButtonStatus(that) {
	
    if (wait == 0) {
        that.removeAttribute("disabled");
        that.value="获取验证码";
        wait = 60;
    } else {
        that.setAttribute("disabled", true);
        that.value=wait+"秒后重新发送";
        wait--;
        setTimeout(function() {
            setButtonStatus(that)
        }, 1000)
    }
}

/**
* 注册按钮
*/
function validateNum() {
	var mobile_code = $('#msg_num').val();
  var obj={
		  code:mobile_code 
		  
  };

    $.ajax({
        url:"<%=basePath%>user/validateNum", // 验证接口
        type: 'post',
        dataType: 'json',
        contentType: "application/json",
        data: JSON.stringify(obj),
        success: function (data) {
           //业务处理
           if(data.result=="success"){
        	   $("#sub").submit();
           }else{
        	   $("#sp").html("验证失败!!!").css("color","red");
           }
        },
        
    });
}
function phones(){
	var phone =$("#phone").val();
	var e =/^1(3|4|5|7|8)\d{9}$/;
	
	$.ajax({
		url:"<%=basePath%>user/getUserByTel",
		data:{"phoneNumber":$("#phone").val()},
		dataType:"json",
		type:"post",
		success:function(data){
			if(data.result=="exist"){
				alert("该用手机号已经存在");
				return iphone;
			}else{
				iphone=true;
			}
		},
		error:function(data){
			
		}
	});
	if(phone.length!=11){
		alert("请输入11位的手机号码");
		return iphone; 

	}
	if(e.test(phone)==false){
		 alert("手机号码有误，请重填"); 

	     return iphone; 
	}
	iphone=true;
	return iphone;

}

function myBlur(obj){
		
	//获取失去焦点的框框name属性值
	 var inputName=obj.name;
	//对用户名进行验证
	if("username"==inputName){
		nameFlag=false;
		if(""==$("input[name='username']").val()){
			$("#nameFont").attr({"size":3,"color":"red"}).html("用户名不能为空");
			return;
		}
		if($("input[name='username']").val().length>10){
			$("#nameFont").attr({"size":3,"color":"red"}).html("用户名不能超过10位");
			return;
		}
		$.ajax({
			url:"<%=basePath%>user/getUserByName",
			data:{"username":$("#username").val()},
			dataType:"json",
			type:"post",
			success:function(data){
				if(data.result=="exist"){
					$("#nameFont").attr({"size":3,"color":"red"}).html("该用户名已经存在");
					return;
				}else{
					$("#nameFont").attr({"size":3,"color":"green"}).html("通过");
					nameFlag=true;
				}
			},
			error:function(data){
				
			}
		});		
		nameFlag=true;
	} 
	if("userpwd"==inputName){
		padFlag=false;
		if(""==$("input[name='userpwd']").val()){
			$("#fontPwd").attr({"size":3,"color":"red"}).html("密码不能为空");
			return;
		}
		if($("input[name='userpwd']").val().length<6||$("input[name='userpwd']").val().length>15){
			$("#fontPwd").attr({"size":3,"color":"red"}).html("密码必须在6到15位之间");
			return;
		}
		$("#fontPwd").attr({"size":3,"color":"green"}).html("通过");
		padFlag=true;
		
	}
	if("twouserpwd"==inputName){
		twoPadFlag=false;
		if($("input[name='userpwd']").val()!=$("input[name='twouserpwd']").val()){
			$("#twoPadFont").attr({"size":3,"color":"red"}).html("两次输入的密码不一致");
			return;
		}
		$("#twoPadFont").attr({"size":3,"color":"green"}).html("两次密码输入一致");
		twoPadFlag=true;
	}
	function mySubmit(){
		if(nameFlag && padFlag && twoPadFlag){
			return true;			
		}else{
			return false;
		}
	}
}
</script>

</body>
</html>