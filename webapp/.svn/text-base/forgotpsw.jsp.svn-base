<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme() + "://"
			+ request.getServerName() + ":" + request.getServerPort()
			+ path + "/";
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<base href="<%=basePath%>">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>p2p网贷平台</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<script src="<%=basePath%>libs/jquery-1.12.4.min.js" type="text/javascript" charset="utf-8"></script>
 <script type="text/javascript" src="<%=basePath%>jq/jquery.js"></script>
<link rel="stylesheet" href="<%=basePath%>css/123.css" type="text/css" media="all">
<link type="text/css" href="<%=basePath%>css/css.css" rel="stylesheet" />
<script src="<%=basePath%>js/regs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="<%=basePath%>Jquery/jquery-1.7.2.min.js"></script>
</head>
<body>
	<h1 align="center" >富二贷公司欢迎你</h1>

	<div class="container w3layouts agileits">
		<div class="for-liucheng">
      		<div class="liulist for-cur"></div>
     		<div class="liulist"></div>
      		<div class="liulist"></div>
      		<div class="liutextbox">
       		<div class="liutext for-cur"><em>1</em><br /><strong>验证身份</strong></div>
       		<div class="liutext"><em>2</em><br /><strong>设置新密码</strong></div>
       		<div class="liutext"><em>3</em><br /><strong>完成</strong></div>
      	</div>
     </div><!--for-liucheng/-->

	    <form action="<%=basePath%>forgetPwd2.jsp" method="post"  id="sub">
	    	<p><font color="white">请输入手机号：</font>
	    		<input id="phone" maxlength="11" onblur="inpPhone()" class="tel w3layouts agileits">&nbsp;&nbsp;<font id="phonefont"></font>
	    		<input type="button" class="btn btn-block btn-flat" value="免费获取验证码" id="verify_refresh" onclick="getMsgNum(this)">
	    	</p>
		    	    	<p><font color="white">请输入验证码：</font>
	    		<input type="text" id="msg_num">&nbsp;&nbsp;<font id="yzmfont"></font>
	    	</p>
	    	
			<input class="send-button w3layouts agileits" type="button" onclick="validateNum(this)" value="确 定">
			
	    </form>
	
</div>
<script type="text/javascript">

	/*输入手机号必须是11位   */
	var iphone=false;
	function inpPhone(){
		
		var phone =$("#phone").val();
		var e =/^1(3|4|5|7|8)\d{9}$/;
		if(phone.length!=11){
			$("#phonefont").attr({"size":3,"color":"red"}).html("请输入11位的手机号码");
			//alert("请输入11位的手机号码");
			return iphone; 

		}
		if(e.test(phone)==false){
			 $("#phonefont").attr({"size":3,"color":"red"}).html("手机号码有误，请重填");
			// alert("手机号码有误，请重填"); 
		     return iphone; 
		}
		$.ajax({
	        url:"<%=basePath%>user/getUserByTel",
	        type: "post",
	        dataType: "json",
	        data: {"phoneNumber":phone},
	        success: function (data) {
	            if(data.result == 'exist') {
	            	$("#phonefont").attr({"size":3,"color":"green"}).html("正确！");
	                //alert("手机号码存在");
	            }else {
	            	$("#phonefont").attr({"size":3,"color":"red"}).html("该手机号不存在！");
	                //alert("该手机号不存在！");
	                return iphone;
	            }
	        },
	        error: function (XMLHttpRequest, textStatus, errorThrown) {
	            alert("错误");
	        }
	    });
		iphone=true;
		return iphone;
	}
	
	var messageData;
	var wait = 60; // 短信验证码60秒后才可获取下一个

	/**
	 * 获取验证码
	 * @param that
	 */
	function getMsgNum(that) {
	    if(iphone==true){
	    	/* alert("手机验证是:"+phoneYz); */
		    setButtonStatus(that); // 设置按钮倒计时
		    var phoneNumber=$("#phone").val();
		    var obj = {
		        phoneNumber: phoneNumber
		    };
		
		    $.ajax({
		        url:"<%=basePath%>user/sendMsg", // 后台短信发送接口
		        type: 'post',
		        dataType: 'json',
		        contentType: "application/json",
		        async: false, //false 同步
		        data: JSON.stringify(obj),
		        xhrFields: {
		            withCredentials: true
		        },
		        success: function (result) {
		            if(result.code == '200') {
		                messageData = result.data;
		            }else {
		                alert("错误码:" + data.code + "  错误信息:" + data.message);
		            }
		        },
		        error: function (XMLHttpRequest, textStatus, errorThrown) {
		            console.log(XMLHttpRequest.status);
		            console.log(XMLHttpRequest.readyState);
		            console.log(textStatus);
		        }
		    });
	    }else{
	    	alert("请输入手机号码");
	    }
	}
	/** 
	 * 设置按钮状态
	 */
	function setButtonStatus(that) {
		
	    if (wait == 0) {
	        that.removeAttribute("disabled");
	        that.value="获取验证码";
	        wait = 60;
	    } else {
	        that.setAttribute("disabled", true);
	        that.value=wait+"秒后重新发送";
	        wait--;
	        setTimeout(function() {
	            setButtonStatus(that)
	        }, 1000)
	    }
	}

	/**
	* 按钮
	*/
	var codeyz=false;
	function validateNum() {
		var mobile_code = $('#msg_num').val();
		var obj={
			code:mobile_code 				  
		};

	    $.ajax({
	        url:"<%=basePath%>user/validateNum", // 验证接口
	        type: 'post',
	        dataType: 'json',
	        contentType: "application/json",
	        data: JSON.stringify(obj),
	        success: function (data) {
	           //业务处理
	           if(data.result=="success"){
	        	   $("#yzmfont").attr({"size":3,"color":"green"}).html("验证码正确！");
	        	   //alert("验证码正确！");
	        	   $("#sub").submit();
	           }else{
	        	   $("#yzmfont").attr({"size":3,"color":"red"}).html("验证码错误！");
	        	   //alert("验证码错误！");	        	   
	           }
	        }	        
	    });

	}
	

</script>

</body>
</html>